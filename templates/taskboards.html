{% extends "main.html" %}

{% block title %}Home{% endblock %}

{% block content %}
<style>
    /* Reset and base styles */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        background-color: #f9fafb;
        color: #1f2937;
        line-height: 1.5;
        padding-top: 75px;
    }

    /* Container styles */
    .wrapper {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    /* Header styles */
    .pageHeader {
        margin-bottom: 2rem;
    }

    .pageTitle {
        font-size: 2.5rem;
        font-weight: 700;
        color: #111827;
    }

    /* Grid layout */
    .boardsGrid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }

    /* Card styles */
    .boardCard {
        background-color: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }

    .boardCard:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .boardCard__header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .boardCard__title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
    }

    .boardCard__tag {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-weight: 500;
    }

    .boardCard__tag--inProgress {
        background-color: #fef3c7;
        color: #92400e;
    }

    .boardCard__tag--completed {
        background-color: #d1fae5;
        color: #065f46;
    }

    .boardCard__tag--backlog {
        background-color: #ede9fe;
        color: #5b21b6;
    }

    .boardCard__count {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 1.5rem;
    }

    .btn,
    .btn--primary {
        width: 100%;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.5rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .btn--view {
        background-color: #e6f7f5;
        color: #0f766e;
    }

    .btn--view:hover {
        background-color: #ccf1ed;
    }

    .btn--primary {
        display: inline-block;
        width: auto;
        padding: 0.75rem 1.5rem;
        background-color: #0f766e;
        color: white;
        font-weight: 500;
    }

    .btn--primary:hover {
        background-color: #0e6b63;
    }

    /* Empty state card */
    .emptyState {
        background-color: white;
        border-radius: 0.75rem;
        padding: 2.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 500px;
        margin: 3rem auto;
    }

    .emptyState__title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 1rem;
    }

    .emptyState__text {
        color: #6b7280;
        margin-bottom: 1.5rem;
    }

    /* Modal styles */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease;
    }

    .overlay--visible {
        opacity: 1;
        visibility: visible;
    }

    .dialog {
        background-color: white;
        border-radius: 0.75rem;
        padding: 2rem;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        transform: translateY(20px);
        transition: transform 0.3s ease;
    }

    .overlay--visible .dialog {
        transform: translateY(0);
    }

    .dialog__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .dialog__title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #111827;
    }

    .dialog__close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #6b7280;
        cursor: pointer;
    }

    .formGroup {
        margin-bottom: 1.5rem;
    }

    .formGroup__label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #374151;
    }

    .formGroup__input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 1rem;
    }

    .formGroup__input:focus {
        outline: none;
        border-color: #0f766e;
        box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
    }

    .formGroup__select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 1rem;
        background-color: white;
    }

    .teamList {
        margin-top: 1rem;
    }

    .teamList__item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: #f3f4f6;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .teamList__name {
        font-weight: 500;
    }

    .teamList__remove {
        background: none;
        border: none;
        color: #ef4444;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .formActions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 2rem;
    }

    .btn--secondary {
        padding: 0.75rem 1.5rem;
        background-color: #f3f4f6;
        color: #374151;
        border: none;
        border-radius: 0.5rem;
        font-weight: 500;
        cursor: pointer;
    }

    .btn--secondary:hover {
        background-color: #e5e7eb;
    }

    /* Responsive styles */
    @media (min-width: 768px) {
        .boardsGrid {
            grid-template-columns: repeat(2, 1fr);
        }

        .pageTitle {
            font-size: 2.75rem;
        }
    }

    @media (min-width: 1024px) {
        .boardsGrid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
</style>

<body>
    <div class="wrapper">
        <header class="pageHeader">
            <h1 class="pageTitle">My Taskboards</h1>
        </header>

        <div id="contentArea">
            <!-- Content will be inserted here by JavaScript -->
        </div>
    </div>

    <!-- Modal for creating a new taskboard -->
    <div class="overlay" id="createDialog">
        <div class="dialog">
            <div class="dialog__header">
                <h2 class="dialog__title">Create New Taskboard</h2>
                <button class="dialog__close" id="dialogClose">&times;</button>
            </div>
            <form id="newBoardForm">
                <div class="formGroup">
                    <label for="boardTitle" class="formGroup__label">Board Title</label>
                    <input type="text" id="boardTitle" class="formGroup__input" placeholder="Enter board title"
                        required>
                </div>

                <div class="formGroup">
                    <label for="teamSelect" class="formGroup__label">Add Collaborators</label>
                    <select id="teamSelect" class="formGroup__select">
                        <option value="">Select a collaborator</option>
                    </select>

                    <div class="teamList" id="teamMembers">
                        <!-- Selected collaborators will appear here -->
                    </div>
                </div>

                <div class="formActions">
                    <button type="button" class="btn--secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn--primary">Create Taskboard</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Sample data for taskboards (empty array to demonstrate empty state)
        let taskboards = [];

        // Sample data for available users
        const availableUsers = [
            { id: 1, name: "John Doe" },
            { id: 2, name: "Jane Smith" },
            { id: 3, name: "Robert Johnson" },
            { id: 4, name: "Emily Davis" },
            { id: 5, name: "Michael Wilson" }
        ];

        // Track selected collaborators
        let selectedCollaborators = [];
        let availableCollaborators = [...availableUsers];


        async function getTaskboardsOfUser() {
            const token = getAuthTokenFromCookies(document.cookie);
            if (token) {
                userEmail = decodeJWT(token).email || "User";
                console.log("user email ", userEmail)
                const taskboardresponse = await fetch(`/gettaskboards/${userEmail}`, { method: 'GET' })
                console.log("task boards response ")
                const taskboardsjson = await taskboardresponse.json()
                taskboards = taskboardsjson?.usertasks?.user_tasks
                console.log("task boards ", taskboards)
                renderTaskboards()
            }
            else {
                document.getElementById('taskboard-container').innerHTML = "<h4 style=''>Please Login to view your taskboards</h4>"
            }
        }

        // Function to get status class
        function getStatusClass(status) {
            switch (status) {
                case "In Progress":
                    return "boardCard__tag--inProgress";
                case "Completed":
                    return "boardCard__tag--completed";
                case "Backlog":
                    return "boardCard__tag--backlog";
                default:
                    return "";
            }
        }

        // Function to render taskboards or empty state
        function renderContent() {
            const container = document.getElementById('contentArea');
            container.innerHTML = '';

            if (taskboards.length === 0) {
                // Render empty state
                const emptyState = document.createElement('div');
                emptyState.className = 'emptyState';
                emptyState.innerHTML = `
          <h2 class="emptyState__title">No Taskboards Available</h2>
          <p class="emptyState__text">Create your first taskboard to get started with organizing your tasks.</p>
          <button class="btn--primary" id="createBtn">Create Taskboard</button>
        `;
                container.appendChild(emptyState);

                // Add event listener to the create button
                document.getElementById('createBtn').addEventListener('click', openCreateModal);
            } else {
                // Render taskboard grid
                const grid = document.createElement('div');
                grid.className = 'boardsGrid';

                taskboards.forEach(board => {
                    const taskText = board.taskCount === 1 ? "task" : "tasks";
                    const card = document.createElement('div');
                    card.className = 'boardCard';
                    card.innerHTML = `
            <div class="boardCard__header">
              <h2 class="boardCard__title">${board.title}</h2>
              <span class="boardCard__tag ${getStatusClass(board.status)}">${board.status || 'New'}</span>
            </div>
            <p class="boardCard__count">${board.taskCount || 0} ${taskText}</p>
            <button class="btn btn--view">View Tasks</button>
          `;

                    grid.appendChild(card);
                });

                container.appendChild(grid);
            }
        }

        // Function to populate collaborator dropdown
        function populateCollaboratorDropdown() {
            const select = document.getElementById('teamSelect');
            select.innerHTML = '<option value="">Select a collaborator</option>';

            availableCollaborators.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                select.appendChild(option);
            });
        }

        // Function to render selected collaborators
        function renderSelectedCollaborators() {
            const container = document.getElementById('teamMembers');
            container.innerHTML = '';

            if (selectedCollaborators.length === 0) {
                container.innerHTML = '<p class="teamList__empty">No collaborators selected</p>';
                return;
            }

            selectedCollaborators.forEach(user => {
                const item = document.createElement('div');
                item.className = 'teamList__item';
                item.innerHTML = `
          <span class="teamList__name">${user.name}</span>
          <button type="button" class="teamList__remove" data-id="${user.id}">Remove</button>
        `;
                container.appendChild(item);
            });

            // Add event listeners to remove buttons
            document.querySelectorAll('.teamList__remove').forEach(button => {
                button.addEventListener('click', function () {
                    const userId = parseInt(this.getAttribute('data-id'));
                    removeCollaborator(userId);
                });
            });
        }

        // Function to add a collaborator
        function addCollaborator(userId) {
            if (!userId) return;

            // Find the user in available collaborators
            const userIndex = availableCollaborators.findIndex(user => user.id === parseInt(userId));
            if (userIndex === -1) return;

            // Move user from available to selected
            const user = availableCollaborators[userIndex];
            availableCollaborators.splice(userIndex, 1);
            selectedCollaborators.push(user);

            // Update UI
            populateCollaboratorDropdown();
            renderSelectedCollaborators();

            // Reset select
            document.getElementById('teamSelect').value = '';
        }

        // Function to remove a collaborator
        function removeCollaborator(userId) {
            // Find the user in selected collaborators
            const userIndex = selectedCollaborators.findIndex(user => user.id === userId);
            if (userIndex === -1) return;

            // Move user from selected to available
            const user = selectedCollaborators[userIndex];
            selectedCollaborators.splice(userIndex, 1);
            availableCollaborators.push(user);

            // Sort available collaborators by ID for consistency
            availableCollaborators.sort((a, b) => a.id - b.id);

            // Update UI
            populateCollaboratorDropdown();
            renderSelectedCollaborators();
        }

        // Function to open create modal
        function openCreateModal() {
            document.getElementById('createDialog').classList.add('overlay--visible');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }

        // Function to close create modal
        function closeCreateModal() {
            document.getElementById('createDialog').classList.remove('overlay--visible');
            document.body.style.overflow = ''; // Restore scrolling

            // Reset form
            document.getElementById('newBoardForm').reset();
            selectedCollaborators = [];
            availableCollaborators = [...availableUsers];
            populateCollaboratorDropdown();
            renderSelectedCollaborators();
        }

        // Function to handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();

            const title = document.getElementById('boardTitle').value.trim();
            if (!title) return;
            console.log("seelcted collab ", selectedCollaborators)
            // Create new taskboard
            const newTaskboard = {
                boardId: Date.now().toString(), // Use timestamp as ID
                name: title,
                admin: "Some",
                collaborators: selectedCollaborators.map(c => c.name)
            };

            const taskBoardResponse = await fetch("/taskboard/submit", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newTaskboard)
            })
            // // Add to taskboards array
            // taskboards.push(newTaskboard);


            // // Close modal and render content
            // closeCreateModal();
            // renderContent();
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function () {
            // Render initial content
            renderContent();
            getTaskboardsOfUser();

            // Populate collaborator dropdown
            populateCollaboratorDropdown();
            renderSelectedCollaborators();

            // Set up event listeners
            document.getElementById('dialogClose').addEventListener('click', closeCreateModal);
            document.getElementById('cancelBtn').addEventListener('click', closeCreateModal);
            document.getElementById('newBoardForm').addEventListener('submit', handleFormSubmit);

            // Event listener for collaborator select
            document.getElementById('teamSelect').addEventListener('change', function () {
                addCollaborator(this.value);
            });
        });
    </script>
</body>
{% endblock %}